<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!--
        Override the standard Batch Picking report template
        to show consolidated quantities instead of individual lines
    -->

    <!-- Replace the main report template -->
    <template id="report_picking_batch" inherit_id="stock_picking_batch.report_picking_batch" name="Batch Picking Consolidated Report">
        <!-- Replace the entire document body -->
        <xpath expr="//t[@t-call='web.html_container']" position="replace">
            <t t-call="web.html_container">
                <t t-foreach="docs" t-as="batch">
                    <t t-call="web.external_layout">
                        <div class="page">
                            <!-- Header -->
                            <div class="row">
                                <div class="col-8">
                                    <h2>
                                        <span>Resumen: </span>
                                        <span t-field="batch.name"/>
                                    </h2>
                                </div>
                                <div class="col-4 text-end">
                                    <t t-if="batch.name">
                                        <img t-att-src="'/report/barcode/?type=%s&amp;value=%s&amp;width=%s&amp;height=%s' % ('Code128', batch.name, 400, 100)" style="width:100%;height:40px" alt="Barcode"/>
                                    </t>
                                </div>
                            </div>

                            <!-- Batch Info -->
                            <div class="row mt-3 mb-3">
                                <div class="col-6">
                                    <strong>Responsable:</strong>
                                    <span t-field="batch.user_id"/>
                                </div>
                                <div class="col-6">
                                    <strong>Estado:</strong>
                                    <span t-field="batch.state"/>
                                </div>
                            </div>

                            <!-- Pickings Table Header -->
                            <h4 class="mt-4 mb-2">Traslados en el Lote</h4>
                            <table class="table table-sm table-bordered">
                                <thead>
                                    <tr style="background-color: #f8f9fa;">
                                        <th style="width: 10%;">Secuencia</th>
                                        <th style="width: 30%;">Trasladar</th>
                                        <th style="width: 30%;">Código de barras</th>
                                        <th style="width: 15%;">Estado</th>
                                        <th style="width: 15%;">Fecha programada</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="batch.picking_ids" t-as="picking">
                                        <tr>
                                            <td><span t-esc="picking_index"/></td>
                                            <td><span t-field="picking.name"/></td>
                                            <td>
                                                <t t-if="picking.name">
                                                    <img t-att-src="'/report/barcode/?type=%s&amp;value=%s&amp;width=%s&amp;height=%s' % ('Code128', picking.name, 400, 100)" style="width:100%;height:30px" alt="Barcode"/>
                                                </t>
                                            </td>
                                            <td><span t-field="picking.state"/></td>
                                            <td><span t-field="picking.scheduled_date" t-options='{"widget": "datetime"}'/></td>
                                        </tr>
                                    </t>
                                </tbody>
                            </table>

                            <div style="page-break-before: always;"/>

                            <!-- Consolidated Products Section -->
                            <h3 class="mt-4 mb-3">Productos Consolidados</h3>

                            <t t-set="consolidated_lines" t-value="batch._get_consolidated_lines()"/>

                            <!-- Group by location route -->
                            <t t-set="grouped_by_route" t-value="{}"/>
                            <t t-foreach="consolidated_lines" t-as="line">
                                <t t-set="route_key" t-value="'DESDE %s\nA %s' % (line['location_name'], line['location_dest_name'])"/>
                                <t t-if="route_key not in grouped_by_route" t-set="grouped_by_route" t-value="{**grouped_by_route, route_key: []}"/>
                                <t t-set="dummy" t-value="grouped_by_route[route_key].append(line)"/>
                            </t>

                            <t t-foreach="grouped_by_route.items()" t-as="route_item">
                                <t t-set="route_label" t-value="route_item[0]"/>
                                <t t-set="route_lines" t-value="route_item[1]"/>

                                <div class="mt-4" style="background-color: #e9ecef; padding: 8px; margin-bottom: 10px;">
                                    <strong style="white-space: pre-line;" t-esc="route_label"/>
                                </div>

                                <table class="table table-sm table-bordered">
                                    <thead style="background-color: #f8f9fa;">
                                        <tr>
                                            <th style="width: 35%;">Producto</th>
                                            <th style="width: 15%;">Cantidad</th>
                                            <th style="width: 20%;">Trasladar</th>
                                            <th style="width: 30%;">Código de barras del producto</th>
                                            <th style="width: 15%;">Paquete</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-foreach="route_lines" t-as="line">
                                            <tr>
                                                <td>
                                                    <t t-if="line['product_code']">
                                                        <span t-esc="'[%s] ' % line['product_code']"/>
                                                    </t>
                                                    <span t-esc="line['product_name']"/>
                                                </td>
                                                <td class="text-center">
                                                    <strong t-esc="'%.2f' % line['quantity']"/>
                                                    <span t-esc="line['uom_name']"/>
                                                </td>
                                                <td>
                                                    <small t-esc="', '.join(line['picking_names'])"/>
                                                </td>
                                                <td class="text-center">
                                                    <t t-if="line['product'].barcode">
                                                        <img t-att-src="'/report/barcode/?type=%s&amp;value=%s&amp;width=%s&amp;height=%s' % ('Code128', line['product'].barcode, 400, 100)" style="width:100%;height:30px" alt="Product Barcode"/>
                                                    </t>
                                                    <t t-else="">
                                                        Código de barras del producto
                                                    </t>
                                                </td>
                                                <td class="text-center">
                                                    <t t-if="line['package_name']">
                                                        <span t-esc="line['package_name']"/>
                                                    </t>
                                                    <t t-if="line['result_package_name'] and line['result_package_name'] != line['package_name']">
                                                        <br/>→ <span t-esc="line['result_package_name']"/>
                                                    </t>
                                                    <t t-if="not line['package_name'] and not line['result_package_name']">
                                                        ID del paquete →
                                                    </t>
                                                </td>
                                            </tr>
                                        </t>
                                    </tbody>
                                </table>
                            </t>

                        </div>
                    </t>
                </t>
            </t>
        </xpath>
    </template>

</odoo>
